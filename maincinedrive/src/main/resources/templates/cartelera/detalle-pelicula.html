<!DOCTYPE html>
<html lang="en">

<head th:object="${pelicula}">
    <meta charset="UTF-8" />
    <link rel="shortcut icon"
        href="https://cinemarkla.modyocdn.com/uploads/ad836c7a-c6ea-4f42-94e4-76bb18d92889/C32x32/Cinemark_Lettermark_RGB_Red.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Style-->
    <link rel="stylesheet" th:href="@{/css/Style_main.css}" />
    <link rel="stylesheet" th:href="@{/css/modal.css}" />
    <!--SweetAlert-->
    <!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="sweetalert2.all.min.js"></script> -->
    <!--FontAwesome-->
    <script src="https://kit.fontawesome.com/0ec2586e1a.js" crossorigin="anonymous"></script>
    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <!-- fancybox -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



    <title th:text="*{titulo}"></title>
</head>

<body>
    <header class="header" th:insert="fragments/header_static :: header_static"></header>
    <div class="container my-5" th:object="${pelicula}">
        <div class="row">
            <div class="col-md-6">
                <img th:src="@{/assets/{filename}(filename=*{rutaPortada})}" th:alt="*{titulo}"
                    class="img-fluid rounded w-100">
            </div>
            <div class="col-md-6">
                <div class="detalle-titulo">
                    <h2 th:text="*{titulo}"></h2>
                </div>
                <div class="mb-3 container-datos">
                    <div>
                        <span class="generoCont" th:each="genero : *{generos}" th:text="${genero.titulo}"></span>
                    </div>
                    <div>
                        <span class="duracionCont" th:text="'Duracion: ' + *{duracionPelicula} +  ' Minutos'"></span>
                        <span class="duracionCont" th:each="cat : *{categoria}"
                            th:text="'Categoria: ' +${cat.categoria}"></span>
                    </div>
                </div>
                <p th:text="*{sinopsis}" class="detalle-parrafo"></p>
                <div class="botones my-3">
                    <button class="btn btn-danger btrn be" onclick="openCompraModal()">Seleccionar Parqueo</button>
                    <a th:href="@{https://www.youtube.com/watch?v={youtubeId}(youtubeId=*{youtubeTrailerId})}"
                        class="btn btn-danger btrn" data-fancybox="">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-film" viewBox="0 0 16 16">
                            <path
                                d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1zm4 0v6h8V1H4zm8 8H4v6h8V9zM1 1v2h2V1H1zm2 3H1v2h2V4zM1 7v2h2V7H1zm2 3H1v2h2v-2zm-2 3v2h2v-2H1zM15 1h-2v2h2V1zm-2 3v2h2V4h-2zm2 3h-2v2h2V7zm-2 3v2h2v-2h-2zm2 3h-2v2h2v-2z" />
                        </svg> Ver trailer
                    </a>
                </div>
                <div id="carrito" style="display: none;">
                    <h3>Carrito de Compras</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="carritoBody">
                            <!-- Aquí se mostrarán los productos del carrito -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Contenedor del carrito de compras -->

    </div>
    <div id="compraModal">
        <div id="modalContent">
            <div class="modal-tittle" th:object="${pelicula}">
                <h3>Estacionamiento Para: <span th:text="*{titulo}" class="pelicula-tittle"></span></h3>

                <div class="button-tittle">
                    <button onclick="closeCompraModal()" class="btn-cerrar-modal"><i class="fa-solid fa-circle-xmark"
                            style="color: #e50246;"></i></button>
                </div>
            </div>

            <form id="compraForm">
                <!-- Verificamos la autenticación -->


                <select id="sede" name="sede" onchange="actualizarAsientos()" class="sede-select">
                    <option th:each="sede : ${sedes}" th:value="${sede.id}" th:text="${sede.nombre}"></option>
                </select>

                <!-- Contenedor de asientos -->
                <div class="" id="contenedorAsientos">

                </div>

                <!-- Contenedor de comida -->
                <div class="Aperitivos-main">
                    <h3 class="tittle-aperitivo">Aperitivos:</h3>
                    <div class="contenedor-comida">

                        <div id="comida" name="comida" class="comida-container" th:each="comida : ${comidas}">
                            <div class="comida-tarjeta">
                                <div class="img-comida">
                                    <img th:src="@{/images/confiteria/{filename}(filename=*{comida.imageUrl})}" alt=""
                                        class="">
                                </div>


                                <div class="card-comida-info">
                                    <div class="card-title">
                                        <h4 th:text="${comida.nombre}"></h4>
                                    </div>
                                    <div class="card-context">
                                        <p th:text="${comida.descripcion}"></p>
                                    </div>
                                    <div class="card-price">
                                        <p th:text="${comida.precio}"></p>
                                        <input type="number" id="cantidadComida" value="0" min="0" max="10">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <button type="button" onclick="carritoCompras()">Ir al carrito</button>
            </form>

        </div>
    </div>
    <footer th:insert="fragments/footer :: footer"></footer>
    <script th:inline="javascript">
        var sedes = /*[[${sedes}]]*/[];
        var asientosPorSede = /*[[${asientos}]]*/ {};
        var asientosPorSede = /*[[${asientosPorSede}]]*/ {};
        console.log('Asientos por sede:', asientosPorSede);
        console.log("sedes:", sedes);
        console.log("asientosPorSedeP:", asientosPorSede);

        function openCompraModal() {
            // Verificar si el usuario está autenticado
            fetch('/api/authenticated')
                .then(response => {
                    console.log('Response status:', response.status);

                    if (response.ok) {
                        // Si está autenticado, mostrar el modal de compra y actualizar la lista de sedes
                        document.getElementById('compraModal').style.display = 'block';
                        actualizarListaSedes();
                    } else {
                        // Si no está autenticado, redirigir al inicio de sesión sin mostrar el modal
                        window.location.href = '/login';
                    }
                })
                .catch(error => {
                    console.error('Error al verificar autenticación:', error);
                });
        }

        function closeCompraModal() {
            document.getElementById('compraModal').style.display = 'none';
        }

        function actualizarListaSedes() {
            renderizarSedes(sedes);
        }

        function renderizarSedes(sedes) {
            var selectSede = document.getElementById('sede');
            selectSede.innerHTML = '';

            for (var i = 0; i < sedes.length; i++) {
                var option = document.createElement('option');
                option.value = sedes[i].id;
                option.text = sedes[i].nombre;
                selectSede.appendChild(option);
            }

            // Al renderizar las sedes, también actualiza los asientos
            actualizarAsientos();
        }

        function actualizarAsientos() {
            var selectSede = document.getElementById('sede');
            var contenedorAsientos = document.getElementById('contenedorAsientos');
            contenedorAsientos.innerHTML = '';

            var idSede = selectSede.value;
            console.log('ID de la sede:', idSede);
            console.log('Asientos por sede:', asientosPorSede);

            // Verifica si la sede seleccionada tiene asientos antes de procesar
            if (asientosPorSede.hasOwnProperty(idSede)) {
                var asientosDeSede = asientosPorSede[idSede];

                // Crear el contenedor de asientos directamente aquí
                var divSede = document.createElement('div');
                divSede.className = 'cancha';

                for (var i = 0; i < asientosDeSede.length; i++) {
                    var asiento = asientosDeSede[i];

                    var divAsiento = document.createElement('div');
                    divAsiento.className = 'lugar';
                    divAsiento.id = 'asiento_' + idSede + '_' + asiento.idAsiento;

                    // Modificar la línea siguiente para incluir el icono
                    divAsiento.innerHTML = asiento.estado === 'OCUPADO'
                        ? '<i class="fa-solid fa-car" style="color: white;"></i>'
                        : '<i class="fa-solid fa-car" style="color: #24262b;"></i>';

                    agregarEventoClic(divAsiento, asiento, idSede);

                    if (asiento.estado === 'OCUPADO') {
                        divAsiento.classList.add('asiento-ocupado');
                    }

                    divSede.appendChild(divAsiento);
                }

                // Adjuntar el contenedor de asientos al DOM en el lugar correcto
                contenedorAsientos.appendChild(divSede);
            }

        }
        function agregarEventoClic(divAsiento, asiento, idSede) {
            divAsiento.id = 'asiento_' + idSede + '_' + asiento.idAsiento;
            divAsiento.addEventListener('click', function () {
                seleccionarAsiento(asiento.idAsiento, idSede);
            });
        }


        var seleccionUsuario = {
            idAsiento: null,
            idSede: null,
            cantidadComida: 0,
            // Otros campos según tus necesidades
        };

        function seleccionarAsiento(idAsiento, idSede) {
            seleccionUsuario.idAsiento = idAsiento;
            seleccionUsuario.idSede = idSede;
            // ... (otras acciones)
        }
        function actualizarCantidadComida() {
            var cantidadComidaSeleccionada = parseInt(document.getElementById('cantidadComida').value);
            seleccionUsuario.cantidadComida = cantidadComidaSeleccionada;
        }

        function mostrarCarrito() {
            var carrito = document.getElementById('carrito');
            carrito.style.display = 'block';

            var carritoBody = document.getElementById('carritoBody');
            carritoBody.innerHTML = '';

            // Crear filas de la tabla con la información del carrito
            // Puedes utilizar un bucle y los datos almacenados en seleccionUsuario

            // Ejemplo de cómo agregar una fila (debes adaptar según tu lógica):
            var fila = document.createElement('tr');
            var producto = 'Asiento'; // Cambiar según tu lógica
            var cantidad = seleccionUsuario.cantidadComida; // Cambiar según tu lógica
            var precioUnitario = 10.99; // Obtener el precio real según el producto seleccionado
            var total = cantidad * precioUnitario;

            fila.innerHTML = `<td>${producto}</td>
                      <td>${cantidad}</td>
                      <td>${precioUnitario}</td>
                      <td>${total}</td>`;

            carritoBody.appendChild(fila);
        }
        function carritoCompras() {
            // ... (otras acciones)

            // Mostrar la información de la selección del usuario en el carrito
            mostrarCarrito();
        }

    </script>
</body>

</html>